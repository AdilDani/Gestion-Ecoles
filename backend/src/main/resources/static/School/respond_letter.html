<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©pondre √† la Demande - Direction R√©gionale</title>
    <style>
        :root {
            --primary-red: #C41E3A;
            --primary-green: #006233;
            --light-green: #228B22;
            --accent-orange: #FF8C00;
            --neutral-white: #FFFFFF;
            --light-gray: #F8F9FA;
            --medium-gray: #6C757D;
            --dark-gray: #343A40;
            --border-gray: #DEE2E6;
            --success-green: #28A745;
            --warning-orange: #FD7E14;
            --danger-red: #DC3545;
            
            --shadow-light: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-medium: 0 4px 8px rgba(0,0,0,0.15);
            --shadow-heavy: 0 8px 16px rgba(0,0,0,0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-red) 0%, #B71C1C 100%);
            color: var(--neutral-white);
            padding: 1rem 0;
            box-shadow: var(--shadow-medium);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .gov-logo {
            width: 50px;
            height: 50px;
            background: var(--neutral-white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-red);
            font-weight: bold;
            font-size: 1.2rem;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        /* Main Container */
        .main-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Back Button */
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-red);
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            color: var(--primary-green);
            transform: translateX(-3px);
        }

        /* Letter Info Section - Compact */
        .letter-info {
            background: var(--neutral-white);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-light);
            margin-bottom: 2rem;
            border-left: 4px solid var(--primary-red);
        }

        .letter-info-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .letter-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 0.5rem;
        }

        .letter-description {
            color: var(--medium-gray);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .letter-meta {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .meta-label {
            font-size: 0.8rem;
            color: var(--medium-gray);
            text-transform: uppercase;
            font-weight: 500;
        }

        .meta-value {
            font-weight: 600;
            color: var(--dark-gray);
        }

        .urgency-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .urgency-urgent {
            background: var(--primary-red);
            color: var(--neutral-white);
        }

        .urgency-normal {
            background: var(--success-green);
            color: var(--neutral-white);
        }

        /* Response Form */
        .response-form {
            background: var(--neutral-white);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow-light);
            margin-bottom: 2rem;
        }

        .form-title {
            color: var(--dark-gray);
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Dynamic Form Fields */
        .form-field {
            margin-bottom: 1.5rem;
        }

        .field-label {
            display: block;
            color: var(--dark-gray);
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .field-input,
        .field-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-gray);
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .field-input:focus,
        .field-textarea:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(0, 98, 51, 0.1);
        }

        .field-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Auto-expanding textarea */
        .field-textarea.auto-expand {
            resize: none;
            overflow: hidden;
        }

        /* Send Button */
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--light-green) 100%);
            color: var(--neutral-white);
            box-shadow: var(--shadow-light);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-secondary {
            background: var(--medium-gray);
            color: var(--neutral-white);
        }

        .btn-secondary:hover {
            background: var(--dark-gray);
        }

        /* Loading State */
        .loading {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Error/Success Messages */
        .message {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            font-weight: 500;
        }

        .message-error {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger-red);
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        .message-success {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success-green);
            border: 1px solid rgba(40, 167, 69, 0.3);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                padding: 0 1rem;
            }
            
            .letter-info,
            .response-form {
                padding: 1.5rem 1rem;
            }
            
            .letter-meta {
                gap: 1rem;
            }
            
            .form-actions {
                justify-content: stretch;
            }
            
            .btn {
                flex: 1;
                justify-content: center;
            }
        }

        /* Fade-in animation */
        .fade-in {
            animation: fadeIn 0.6s ease forwards;
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="gov-logo">üè´</div>
            <h1 class="header-title">Direction R√©gionale - R√©ponse √† la Demande</h1>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Back Button -->
        <a href="received_letters.html" class="back-button fade-in">
            ‚Üê Retour aux lettres
        </a>

        <!-- Letter Information Section (Compact) -->
        <div class="letter-info fade-in" id="letterInfoSection" style="display: none;">
            <div class="letter-info-header">
                <div>
                    <h2 class="letter-title" id="letterTitle">Chargement...</h2>
                    <p class="letter-description" id="letterDescription">Chargement de la description...</p>
                </div>
                <span class="urgency-badge" id="urgencyBadge">Normal</span>
            </div>
            
            <div class="letter-meta">
                <div class="meta-item">
                    <span class="meta-label">Re√ßu le</span>
                    <span class="meta-value" id="sentAtValue">--</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">√âch√©ance</span>
                    <span class="meta-value" id="deadlineValue">--</span>
                </div>
            </div>
        </div>

        <!-- Response Form -->
        <div class="response-form fade-in" id="responseFormSection" style="display: none;">
            <h3 class="form-title">
                ‚úèÔ∏è Formulaire de R√©ponse
            </h3>
            
            <!-- Dynamic form fields will be inserted here -->
            <div id="dynamicFields"></div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-primary" id="sendResponseBtn">
                    üì§ Envoyer la R√©ponse
                </button>
            </div>
        </div>

        <!-- Loading/Error Messages -->
        <div id="messageContainer"></div>
    </main>

    <script>
        // Global variables
        let currentLetter = null;
        let letterId = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Get letter ID from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            letterId = urlParams.get('id');
            
            if (!letterId) {
                showMessage('error', 'Aucun ID de lettre fourni dans l\'URL.');
                return;
            }
            
            loadLetter();
            
            // Add event listener for send response button
            document.getElementById('sendResponseBtn').addEventListener('click', handleSendResponse);
        });

        // Load letter data from API
        async function loadLetter() {
            try {
                const response = await fetch(`http://localhost:8080/api/letters/${letterId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch letter: ${response.status}`);
                }
                
                currentLetter = await response.json();
                console.log('Loaded letter:', currentLetter);
                
                displayLetterInfo();
                createDynamicForm();
                
                // Show the sections
                document.getElementById('letterInfoSection').style.display = 'block';
                document.getElementById('responseFormSection').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading letter:', error);
                showMessage('error', `Erreur lors du chargement de la lettre: ${error.message}`);
            }
        }

        // Display letter information in the compact info section
        function displayLetterInfo() {
            if (!currentLetter) return;
            
            const letterDetails = currentLetter.letterDetailsResponse;
            const template = currentLetter.template;
            
            // Template name and description
            const titleElement = document.getElementById('letterTitle');
            const descriptionElement = document.getElementById('letterDescription');
            
            titleElement.textContent = template && template.name ? template.name : 'Demande de Rapport';
            descriptionElement.textContent = template && template.description ? template.description : 'Description non disponible';
            
            // Urgency badge
            const urgencyBadge = document.getElementById('urgencyBadge');
            const urgency = letterDetails.urgency || '';
            const isUrgent = urgency.toLowerCase() === 'urgent' || urgency.toLowerCase() === 'high';
            
            urgencyBadge.textContent = isUrgent ? 'Urgent' : 'Normal';
            urgencyBadge.className = isUrgent ? 'urgency-badge urgency-urgent' : 'urgency-badge urgency-normal';
            
            // Dates
            const sentAtElement = document.getElementById('sentAtValue');
            const deadlineElement = document.getElementById('deadlineValue');
            
            sentAtElement.textContent = letterDetails.sentAt || 'No date found';
            deadlineElement.textContent = letterDetails.deadline || 'No date found';
        }

        // Create dynamic form fields based on template fields
        function createDynamicForm() {
            if (!currentLetter || !currentLetter.template || !currentLetter.template.fields) return;
            
            const fieldsContainer = document.getElementById('dynamicFields');
            const fields = currentLetter.template.fields;
            
            // Clear existing fields
            fieldsContainer.innerHTML = '';
            
            fields.forEach((fieldName, index) => {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'form-field';
                
                // Create label
                const label = document.createElement('label');
                label.className = 'field-label';
                label.htmlFor = `field_${index}`;
                label.textContent = fieldName;
                
                // Create textarea (auto-expanding)
                const textarea = document.createElement('textarea');
                textarea.id = `field_${index}`;
                textarea.name = `field_${index}`;
                textarea.className = 'field-textarea auto-expand';
                textarea.placeholder = `Saisissez votre r√©ponse pour: ${fieldName}`;
                textarea.rows = 3;
                
                // Add auto-expand functionality
                addAutoExpandFunctionality(textarea);
                
                fieldDiv.appendChild(label);
                fieldDiv.appendChild(textarea);
                fieldsContainer.appendChild(fieldDiv);
            });
        }

        // Add auto-expanding functionality to a textarea
        function addAutoExpandFunctionality(textarea) {
            // Function to adjust height
            function adjustHeight() {
                textarea.style.height = 'auto';
                textarea.style.height = Math.max(textarea.scrollHeight, 100) + 'px';
            }
            
            // Add event listeners
            textarea.addEventListener('input', adjustHeight);
            textarea.addEventListener('paste', function() {
                // Small delay to let paste content be processed
                setTimeout(adjustHeight, 10);
            });
            
            // Initial adjustment
            adjustHeight();
        }

        // Handle send response button click
        async function handleSendResponse() {
            try {
                const sendButton = document.getElementById('sendResponseBtn');
                
                // Disable button and show loading state
                sendButton.disabled = true;
                sendButton.classList.add('loading');
                sendButton.innerHTML = '‚è≥ Envoi en cours...';
                
                // Collect form data
                const formData = collectFormData();
                
                if (!formData || Object.keys(formData).length === 0) {
                    throw new Error('Aucune donn√©e √† envoyer. Veuillez remplir au moins un champ.');
                }
                
                // Create response object
                const responseData = {
                    letterId: letterId,
                    schoolId: getCurrentSchoolId(), 
                    fieldResponses: formData,
                    sentAt: new Date().toISOString().replace('T', ' ').substring(0, 19) // Format: yyyy-MM-dd HH:mm:ss
                };
                
                console.log('Sending response data:', responseData);
                
                // TODO: Send to API when response endpoint is available
                // For now, just show success message
                showMessage('success', 'R√©ponse envoy√©e avec succ√®s! (Simulation - API √† impl√©menter)');
                
                // TODO: Redirect back to received letters after success
                // setTimeout(() => {
                //     window.location.href = 'received_letters.html';
                // }, 2000);
                
            } catch (error) {
                console.error('Error sending response:', error);
                showMessage('error', `Erreur lors de l'envoi: ${error.message}`);
            } finally {
                // Re-enable button
                const sendButton = document.getElementById('sendResponseBtn');
                sendButton.disabled = false;
                sendButton.classList.remove('loading');
                sendButton.innerHTML = 'üì§ Envoyer la R√©ponse';
            }
        }

        // Collect data from all dynamic form fields
        function collectFormData() {
            const formData = {};
            const fieldsContainer = document.getElementById('dynamicFields');
            const textareas = fieldsContainer.querySelectorAll('.field-textarea');
            
            textareas.forEach((textarea, index) => {
                const value = textarea.value.trim();
                if (value) {
                    const fieldName = currentLetter.template.fields[index];
                    formData[fieldName] = value;
                }
            });
            
            return formData;
        }

        // Get current school ID (from localStorage)
        function getCurrentSchoolId() {
            return localStorage.getItem('currentSchoolId') || 'unknown';
        }

        function showMessage(type, text) {
            const container = document.getElementById('messageContainer');
            const messageClass = type === 'error' ? 'message-error' : 'message-success';
            
            container.innerHTML = `
                <div class="message ${messageClass}">
                    ${text}
                </div>
            `;
        }
    </script>
</body>
</html>